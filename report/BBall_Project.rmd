---
title: "BBall Stats Data Cleaning"
author: "Cassandra Ortiz-Nelsen"
date: "Monday, Nov 17, 2025"
output: html_document
---

```{r setup, include=FALSE}
# Load packages
library(dplyr)
library(ggplot2)
library(janitor)
library(rvest)

# Create folder if it doesn't exist
if(!dir.exists("code")) dir.create("code")

# Set global chunk options
knitr::opts_chunk$set(
  echo = FALSE,       # hide all code
  results = 'hide',   # hide all printed output
  message = FALSE,    # hide package messages
  warning = FALSE     # hide warnings
)
```


```{r, echo=FALSE}
#URL for NBA 2025 per-minute stats
url <- "https://www.basketball-reference.com/leagues/NBA_2025_per_minute.html"

#Download raw HTML only if it doesn't already exist
if (!file.exists("code/NBA_2025_per_minute_raw.html")) {
download.file(url, destfile = "code/NBA_2025_per_minute_raw.html", mode = "wb")
}
```


```{r, echo=FALSE}
#Read HTML
html_file <- "code/NBA_2025_per_minute_raw.html"
page <- read_html(html_file)
table_node <- html_node(page, "table#per_minute_stats")
nba_pm_df <- html_table(table_node, fill = TRUE)

#Remove repeated header rows safely
nba_pm_df <- nba_pm_df[trimws(nba_pm_df$Player) != "Player", ]

#Clean column names
nba_pm_df <- janitor::clean_names(nba_pm_df)
```

```{r, echo=FALSE}
#Rename to descriptive names
new_names <- c(
"rank", "player", "age", "team", "position",
"games_played", "games_started", "minutes_per_game",
"field_goals_made", "field_goals_attempted", "field_goal_pct",
"three_point_made", "three_point_attempted", "three_point_pct",
"two_point_made", "two_point_attempted", "two_point_pct",
"effective_fg_pct", "free_throws_made", "free_throws_attempted",
"free_throw_pct", "offensive_rebounds", "defensive_rebounds",
"total_rebounds", "assists", "steals", "blocks", "turnovers",
"personal_fouls", "points", "awards"
)
names(nba_pm_df) <- new_names
```

```{r, echo=FALSE}
#Convert numeric/stat columns safely (exclude player, team, position)
numeric_cols <- setdiff(names(nba_pm_df), c("player", "team", "position"))
nba_pm_df[numeric_cols] <- lapply(nba_pm_df[numeric_cols], function(x) {
as.numeric(gsub("%", "", x))
})
```

```{r, echo=FALSE}
#Check first few rows of key columns
print(head(nba_pm_df$player))
print(head(nba_pm_df$team))
print(head(nba_pm_df$position))

#Check structure
str(nba_pm_df)
```

```{r, echo=FALSE}
#Save cleaned CSV without printing "writing" message
invisible(write.csv(nba_pm_df, "code/NBA_2025_per_minute_clean.csv", row.names = FALSE))
```


```{r, echo=FALSE}
# 1. Make sure positions are not NA
nba_pm_df <- nba_pm_df %>%
  mutate(position = ifelse(is.na(position), "Unknown", position))

# 2. Create steal-to-foul ratio
nba_pm_df <- nba_pm_df %>%
  mutate(steal_foul_ratio = ifelse(personal_fouls > 0, steals / personal_fouls, NA))

# 3. Identify top 10 players by steal-to-foul ratio
top_players <- nba_pm_df %>%
  filter(!is.na(steal_foul_ratio)) %>%
  arrange(desc(steal_foul_ratio)) %>%
  slice_head(n = 10)
```


```{r, echo=FALSE}
# --- 1. Read the raw HTML file ---
html_file <- "code/NBA_2025_per_minute_raw.html"
page <- read_html(html_file)

# --- 2. Pull the main table ---
table_node <- html_node(page, "table#per_minute_stats")
nba_pm_df <- html_table(table_node, fill = TRUE)

# --- 3. Remove repeated header rows ---
nba_pm_df <- nba_pm_df[nba_pm_df$Player != "Player", ]

# --- 4. Clean column names ---
nba_pm_df <- nba_pm_df %>%
  janitor::clean_names()

# --- 5. Standardize positions ---
nba_pm_df <- nba_pm_df %>%
  mutate(
    position = case_when(
      grepl("G", pos) ~ "G",
      grepl("F", pos) ~ "F",
      grepl("C", pos) ~ "C",
      TRUE ~ "Unknown"
    )
  )

# --- 6. Clean numeric columns ---
numeric_cols <- setdiff(names(nba_pm_df), c("player", "position", "team"))
nba_pm_df[numeric_cols] <- lapply(nba_pm_df[numeric_cols], function(x) as.numeric(gsub("%","", x)))

# --- 7. Create steal-to-foul ratio ---
nba_pm_df <- nba_pm_df %>%
  mutate(steal_foul_ratio = ifelse(pf > 0, stl / pf, NA))

# --- 8. Replace remaining NAs in position with "Unknown" ---
nba_pm_df <- nba_pm_df %>%
  mutate(position = ifelse(is.na(position), "Unknown", position))


# --- 9a. Top 10 players by steal-to-foul ratio ---
top_players <- nba_pm_df %>%
  filter(!is.na(steal_foul_ratio)) %>%
  arrange(desc(steal_foul_ratio)) %>%
  slice_head(n = 10)

# --- 9b. Subset to only 1st, 3rd, 5th players to avoid overlapping labels ---
top_players_subset <- top_players %>%
  slice(c(1, 3, 5))


# --- 10. Candy-colored scatterplot ---
ggplot(nba_pm_df, aes(x = pf, y = steal_foul_ratio, color = position)) +
  geom_point(alpha = 0.7, size = 2.5, position = position_jitter(width = 0.2, height = 0)) +
  geom_text(
  data = top_players_subset, 
  aes(label = player), 
  vjust = -0.8, 
  size = 3, 
  color = "black"
  ) +
  geom_smooth(aes(group=1), method = "lm", se = FALSE, color = "red3", linetype = "dashed") +
  scale_color_manual(values = c(
    "G" = "hotpink",
    "F" = "#FFD700",  
    "C" = "#1E90FF",  
    "Unknown" = "gray50"
  )) +
  labs(
    title = "Steal-to-Foul Ratio (NBA 2025)",
    subtitle = "Higher values indicate high-risk, high-reward defenders",
    x = "Personal Fouls per Game",
    y = "Steals per Game",
    color = "Position",
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_line(color = "gray90"),
    plot.margin = margin(t = 20, r = 10, b = 10, l = 10)
  ) +
  coord_cartesian(clip = "off")
```



About the Data:Launched in 2004, Basketball Reference.com/Sports Reference is 
a dependable and credible basketball statistics source and uses official NBA data.

Key Takeaway: High foul players make risky decisions, and ultimately lose points for their team. The idea of 
"high risk high reward" doesn't seem to be the case in the NBA. More aggressive players don't benefit their team according to data from basketball-reference.com. A few notable players who should consider becoming less aggressive are: Josh Christopher with Miami Heat, JD Davison and David Roddy with the Houston Rockets. Houston is going to need to lasso their Rockets!

<br><br><br>